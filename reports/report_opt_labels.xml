<odoo>
    <data>
        <record id="paperformat_opt_labels_letter" model="report.paperformat">
            <field name="name">Etiquetas OPT (A4)</field>
            <field name="default" eval="False"/>
            <field name="format">A4</field>
            <field name="page_height">0</field>
            <field name="page_width">0</field>
            <field name="orientation">Portrait</field>
            <field name="margin_top">2</field>
            <field name="margin_bottom">0</field>
            <field name="margin_left">0</field>
            <field name="margin_right">0</field>
            <field name="header_line" eval="False"/>
            <field name="header_spacing">0</field>
            <field name="dpi">90</field>
        </record>

        <record id="action_report_opt_labels" model="ir.actions.report">
            <field name="name">Etiquetas OPT</field>
            <field name="model">mrp.master.order</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">alterben_mrp_master_order.report_opt_labels</field>
            <field name="print_report_name">'Etiquetas OPT - ' + (object.name or '')</field>
            <field name="paperformat_id" ref="alterben_mrp_master_order.paperformat_opt_labels_letter"/>
        </record>

        <template id="report_opt_labels">
            <t t-call="web.basic_layout">
                <style>
                    /* ===================== */
                    /* CONFIGURACIÓN DE PÁGINA */
                    /* ===================== */
                    @page {
                        margin-top: 8mm;
                        margin-right: 6mm;
                        margin-bottom: 6mm;
                        margin-left: 6mm;
                    }

                    html, body {
                        margin: 0 !important;
                        padding: 0 !important;
                        border: none !important;
                        background: #fff !important;
                    }

                    /* ===================== */
                    /* ELIMINAR PADDING/MARCOS DEL LAYOUT (CLAVE PARA CENTRADO) */
                    /* ===================== */
                    .o_report_layout,
                    .o_basic_layout,
                    .page {
                        border: none !important;
                        outline: none !important;
                        box-shadow: none !important;
                        background: #fff !important;
                    }

                    /* Odoo a veces mete padding aquí: lo neutralizamos */
                    .page {
                        margin: 0 !important;
                        padding: 0 !important;
                    }

                    /* ===================== */
                    /* PÁGINA */
                    /* ===================== */
                    .label-page {
                        margin: 0 !important;
                        padding: 0 !important;
                        page-break-after: always;
                    }
                    .label-page:last-child {
                        page-break-after: auto;
                    }

                    /* ===================== */
                    /* HEADER */
                    /* ===================== */
                    .label-header {
                        height: 4mm;
                        display: flex;
                        align-items: center;
                        justify-content: flex-end;
                        padding: 0 5mm;
                        margin-bottom: 4mm; /* separa del primer barcode */
                    }

                    .label-color {
                        font-size: 6pt;
                        font-weight: bold;
                    }

                    /* ===================== */
                    /* TABLA DE ETIQUETAS */
                    /* ===================== */
                    table.label-table {
                        width: 100%;
                        border-collapse: collapse;
                        table-layout: fixed;
                        border: none !important;
                        margin: 0 !important;
                    }

                    table.label-table tr,
                    table.label-table td {
                        border: none !important;
                    }

                    table.label-table td {
                        width: 33.33%;
                        height: 29.7mm;
                        padding: 1mm 3mm;
                        box-sizing: border-box;
                        vertical-align: middle;
                        text-align: center;
                        page-break-inside: avoid;
                    }

                    /* ===================== */
                    /* CONTENIDO DE ETIQUETA (CENTRADO REAL) */
                    /* ===================== */
                    .label-cell {
                        height: 100%;
                        width: 100%;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    }

                    /* BARCODE: ancho fijo relativo y centrado real */
                    .label-barcode {
                        display: block;
                        width: 92%;              /* hace que TODOS ocupen lo mismo */
                        height: 12mm;
                        margin: 0 auto 1mm auto;  /* centrado real */
                        object-fit: contain;
                    }

                    /* TEXTO */
                    .label-text,
                    .label-ref,
                    .label-name {
                        width: 100%;
                        text-align: center;       /* - fuerza centrado de texto */
                        line-height: 1.1;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }

                    .label-text,
                    .label-ref {
                        font-size: 9pt;
                        font-weight: normal;
                    }

                    /* NOMBRE EN NEGRITA */
                    .label-name {
                        font-size: 9pt;
                        font-weight: bold;
                    }
                </style>
                <t t-foreach="pages" t-as="page">
                    <div class="page label-page">
                        <div class="label-header">
                            <span class="label-color" t-esc="page.get('color') or ''"/>
                        </div>
                        <table class="label-table">
                            <tbody>
                                <t t-foreach="range(10)" t-as="r">
                                    <tr>
                                        <t t-foreach="range(3)" t-as="c">
                                            <t t-set="idx" t-value="r * 3 + c"/>
                                            <td>
                                                <t t-if="idx &lt; len(page.get('labels')) and page.get('labels')[idx]">
                                                    <t t-set="label" t-value="page.get('labels')[idx]"/>
                                                    <div class="label-cell">
                                                        <t t-if="label.get('barcode')">
                                                            <img class="label-barcode"
                                                                 t-att-src="'/report/barcode/?barcode_type=Code128&amp;value=%s&amp;width=260&amp;height=50&amp;humanreadable=0' % label.get('barcode')"/>
                                                        </t>
                                                        <div class="label-text" t-esc="label.get('barcode_text') or ''"/>
                                                        <div class="label-name" t-esc="label.get('name') or ''"/>
                                                        <div class="label-ref" t-esc="label.get('reference') or ''"/>
                                                    </div>
                                                </t>
                                            </td>
                                        </t>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>
            </t>
        </template>
    </data>
</odoo>
