<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Placeholder de la vista base original para mantener compatibilidad con herencias previas -->
    <record id="view_mrp_master_order_form" model="ir.ui.view">
        <field name="name">mrp.master.order.form.placeholder</field>
        <field name="model">mrp.master.order</field>
        <field name="priority">0</field>
        <field name="active">0</field>
        <field name="arch" type="xml">
            <form string="Orden Maestra (legacy)">
                <sheet class="o_form_sheet o_form_sheet_full">
                    <group>
                        <field name="name"/>
                        <field name="type_id"/>
                        <field name="stage_type"/>
                        <field name="date_planned"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Formularios separados por etapa -->

    <!-- Formulario independiente Curvado/PVB -->
    <record id="view_mrp_master_order_form_curvado_split" model="ir.ui.view">
        <field name="name">mrp.master.order.form.curvado.split</field>
        <field name="model">mrp.master.order</field>
        <field name="arch" type="xml">
            <form string="Orden Curvado/PVB">
                <header>
                    <button name="action_confirm_prompt" type="object" string="Confirmar" class="btn-primary"/>
                    <button name="action_view_productions" type="object" string="Ver MOs (Esta orden)" class="btn-secondary"/>
                    <button name="action_view_workorders" type="object" string="Ver WOs (Esta orden)" class="btn-secondary"/>
                    <button name="action_open_print_wizard" type="object" string="Imprimir" class="btn-secondary"/>
                    <button name="action_print_opt_labels" type="object" string="Imprimir etiquetas" class="btn-secondary"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,done,cancel"/>
                    <div class="oe_button_box" name="etapa_buttons">
                        <span class="font-weight-bold">ETAPA:</span>
                        <button name="action_open_lines_tab" type="object" string="HORNO P - T1" class="btn btn-secondary" context="{'mrp_tab':'hp_t1'}"/>
                        <button name="action_open_lines_tab" type="object" string="HORNO P - T2" class="btn btn-secondary" context="{'mrp_tab':'hp_t2'}"/>
                        <button name="action_open_lines_tab" type="object" string="HORNO G - T1" class="btn btn-secondary" context="{'mrp_tab':'hg_t1'}"/>
                        <button name="action_open_lines_tab" type="object" string="HORNO G - T2" class="btn btn-secondary" context="{'mrp_tab':'hg_t2'}"/>
                        <button name="action_open_lines_tab" type="object" string="CORTE PVB" class="btn btn-secondary" context="{'mrp_tab':'corte'}"/>
                    </div>
                </header>
                <sheet class="o_form_sheet o_form_sheet_full">
                    <field name="needs_refresh" invisible="1"/>
                    <field name="last_refresh_at" invisible="1"/>
                    <field name="light_mode" invisible="1"/>
                    <group>
                        <group>
                            <field name="type_id" required="1"/>
                            <field name="stage_type" readonly="1"/>
                            <field name="name" string="Código maestro" readonly="1"/>
                            <field name="date_planned" required="1"/>
                            <field name="turn_duration_small"/>
                            <field name="turn_duration_big"/>
                            <field name="location_dest_id" readonly="1"/>
                            <field name="available_product_ids" invisible="1"/>
                            <field name="uom_id" invisible="1"/>
                            <field name="product_id" invisible="1"/>
                        </group>
                        <group>
                            <field name="company_id" readonly="1"/>
                        </group>
                    </group>


                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Formulario independiente OPT -->
    <record id="view_mrp_master_order_form_opt_split" model="ir.ui.view">
        <field name="name">mrp.master.order.form.opt.split</field>
        <field name="model">mrp.master.order</field>
        <field name="arch" type="xml">
            <form string="Orden Producto Terminado (OPT)">
                <header>
                    <button name="action_confirm_prompt" type="object" string="Confirmar" class="btn-primary"/>
                    <button name="action_view_productions" type="object" string="Ver MOs (Esta orden)" class="btn-secondary"/>
                    <button name="action_view_workorders" type="object" string="Ver WOs (Esta orden)" class="btn-secondary"/>
                    <button name="action_open_print_wizard" type="object" string="Imprimir" class="btn-secondary" context="{'default_stage_type': 'opt'}"/>
                    <button name="action_cargar_datos_opt" type="object" string="Cargar datos" class="btn-secondary"/>
                    <button name="action_recalculate_opt" type="object" string="Recalcular OPT" class="btn-secondary"
                            invisible="1"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,done,cancel"/>
                    <div class="oe_button_box" name="etapa_buttons_opt">
                        <span class="font-weight-bold">ETAPA:</span>
                        <button name="action_open_lines_tab" type="object" string="ENSAMBLADO" class="btn btn-secondary" context="{'mrp_tab':'ensamblado'}"/>
                        <button name="action_open_lines_tab" type="object" string="PREVACIADO Y LAMINADO" class="btn btn-secondary" context="{'mrp_tab':'prevaciado'}"/>
                        <button name="action_open_lines_tab" type="object" string="INSPECCION FINAL" class="btn btn-secondary" context="{'mrp_tab':'inspeccion_final'}"/>
                    </div>
                </header>
                <sheet>
                    <field name="needs_refresh" invisible="1"/>
                    <field name="last_refresh_at" invisible="1"/>
                    <field name="light_mode" invisible="1"/>
                    <group>
                        <group>
                            <field name="type_id" required="1"/>
                            <field name="stage_type" readonly="1"/>
                            <field name="name" string="Código maestro" readonly="1"/>
                            <field name="date_planned" required="1"/>
                            <field name="location_dest_id" readonly="1"/>
                            <field name="ct_complete_master" readonly="1"/>
                            <field name="available_product_ids" invisible="1"/>
                            <field name="product_id" invisible="1"/>
                        </group>
                        <group>
                            <field name="source_master_order_id" domain="[('stage_type','=','curvado_pvb')]" context="{'default_stage_type':'curvado_pvb'}"/>
                            <field name="company_id" readonly="1"/>
                        </group>
                    </group>
                    <field name="ct_banner_html" widget="html" nolabel="1"/>
                    <field name="delivery_picking_count" invisible="1"/>
                    <field name="opt_recalc_done" invisible="1"/>


                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <record id="view_mrp_master_order_line_tree_tab" model="ir.ui.view">
        <field name="name">mrp.master.order.line.tree.tab</field>
        <field name="model">mrp.master.order.line</field>
        <field name="arch" type="xml">
            <tree editable="bottom" js_class="mrp_master_order_line_tree" class="ab-mrp-line-grid">
                <header>
                    <button name="action_open_add_open_mo_wizard_line" type="object"
                            string="Agregar MOs abiertas" class="btn-secondary ab-tree-header-btn"/>
                    <button name="action_generate_pending_tab_line" type="object"
                            string="Generar MOs" class="btn-secondary ab-tree-header-btn"/>
                    <button name="action_view_mos_tab_line" type="object"
                            string="Ver MOs" class="btn-secondary ab-tree-header-btn"/>
                    <button name="action_view_wos_tab_line" type="object"
                            string="Ver WOs" class="btn-secondary ab-tree-header-btn"/>
                    <button name="action_recalculate_opt_line" type="object"
                            string="Recalcular OPT" class="btn-secondary ab-tree-header-btn"
                            invisible="context.get('mrp_tab') != 'ensamblado'"/>
                    <button name="action_confirm_corte_pvb_line" type="object"
                            string="Confirmar corte PVB" class="btn-secondary ab-tree-header-btn"
                            invisible="context.get('mrp_tab') != 'corte'"/>
                    <button name="action_recalcular_corte_line" type="object"
                            string="Recalcular PVB" class="btn-secondary ab-tree-header-btn"
                            invisible="context.get('mrp_tab') != 'corte'"/>
                    <button name="action_mark_tab_done_prompt_line" type="object"
                            string="Marcar como hecho" class="btn-secondary ab-tree-header-btn"
                            invisible="context.get('mrp_tab') != 'inspeccion_final'"/>
                    <button name="action_generate_warehouse_delivery_line" type="object"
                            string="Entregar a bodega" class="btn-secondary"/>
                    <button name="action_view_deliveries_line" type="object"
                            string="Ver entregas" class="btn-secondary"/>
                </header>
                <field name="display_index" string="#" readonly="1" optional="show"/>
                <field name="product_code" string="Codigo" optional="show"/>
                <field name="product_id" required="1" options="{'no_create': True, 'no_create_edit': True}" optional="show"/>
                <!-- Campos específicos para Inspección Final (junto a producto) -->
                <field name="mark_done_selected" column_invisible="context.get('mrp_tab') != 'inspeccion_final'" optional="show"/>
                <field name="qty_to_liberar" column_invisible="context.get('mrp_tab') != 'inspeccion_final'" optional="show"/>
                <field name="reciclo_qty" column_invisible="context.get('mrp_tab') != 'inspeccion_final'" optional="show"/>
                <field name="almacen_qty" column_invisible="context.get('mrp_tab') != 'inspeccion_final'" optional="show"/>
                <field name="x_studio_cae" column_invisible="context.get('mrp_tab') != 'inspeccion_final'" optional="show"/>
                <field name="segunda_qty" column_invisible="context.get('mrp_tab') != 'inspeccion_final'" optional="show"/>
                <field name="destruidos_qty" column_invisible="context.get('mrp_tab') != 'inspeccion_final'" optional="show"/>
                <field name="vitrificacion_ok" column_invisible="context.get('mrp_tab') != 'inspeccion_final'" optional="show"/>
                <field name="qty_to_deliver" column_invisible="context.get('mrp_tab') != 'inspeccion_final'" optional="show"/>
                <field name="product_qty_mo" string="Cant." sum="Total" optional="show"/>
                <field name="arrastre_qty" string="Arrastre" readonly="1" sum="Total" optional="show"/>
                <field name="qty_total" string="Cant. total" sum="Total" optional="show"/>
                <field name="cantidad_real" string="Cant. real" readonly="1" sum="Total" optional="show"/>
                <field name="pending_qty" string="Pendiente" sum="Total" readonly="1" optional="show"/>
                <field name="scrap_qty" string="Desechos" readonly="1" sum="Total" optional="show"/>
                <field name="uom_id" string="UdM" readonly="1" optional="show"/>
                <field name="pedido_original_id" string="Pedido Original" options="{'no_create': True, 'no_create_edit': True}" optional="show"/>
                <field name="note" string="Notas" optional="show"/>
                <field name="production_id" string="Orden de Fabricacion" optional="show"/>
                <field name="mo_state" string="Estado MO" readonly="1" optional="show"/>
                <!-- Campos específicos para Corte PVB -->
                <field name="ancho_pvb" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="longitud_calc" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="espesor_pvb" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="color_pvb" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="tipo_pvb" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="ficha_pvb" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="cantidad_piezas_text" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="pvb_cortado_text" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="codigo_rollo" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="sobrante_pvb" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="m2_lote" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <field name="largo" column_invisible="context.get('mrp_tab') != 'corte'" optional="show"/>
                <!-- Campos específicos para Ensamblado -->
                <field name="cantidad_ensamblada" column_invisible="context.get('mrp_tab') != 'ensamblado'" optional="show"/>
                <!-- Campos específicos para Prevacido -->
                <field name="qty_to_prevaciar" column_invisible="context.get('mrp_tab') != 'prevaciado'" optional="show"/>
                <button name="action_open_novedades_inspeccion" string="Novedades" type="object" class="btn-secondary"
                        invisible="context.get('mrp_tab') != 'inspeccion_final'"/>
            </tree>
        </field>
    </record>

    <!-- Vista en árbol común -->
    <record id="view_mrp_master_order_tree" model="ir.ui.view">
        <field name="name">mrp.master.order.tree</field>
        <field name="model">mrp.master.order</field>
        <field name="arch" type="xml">
            <tree string="Ordenes Maestras">
                <field name="name" string="Código maestro" optional="show"/>
                <field name="stage_type" optional="show"/>
                <field name="type_id" optional="show"/>
                <field name="date_planned" optional="show"/>
                <field name="company_id" optional="show"/>
                <field name="state" optional="show"/>
            </tree>
        </field>
    </record>

    <!-- Acción legado (inactiva) para compatibilidad con menú antiguo -->
    <record id="action_mrp_master_order" model="ir.actions.act_window">
        <field name="name">Órdenes Maestras (legado)</field>
        <field name="res_model">mrp.master.order</field>
        <field name="view_mode">tree,form</field>
        <field name="views">[(ref('alterben_mrp_master_order.view_mrp_master_order_tree'),'tree'),(ref('alterben_mrp_master_order.view_mrp_master_order_form_curvado_split'),'form')]</field>
        <field name="context">{'default_stage_type':'curvado_pvb'}</field>
    </record>

    <!-- Acción Curvado/PVB -->
    <record id="action_mrp_master_order_curvado" model="ir.actions.act_window">
        <field name="name">Órdenes Curvado/PVB</field>
        <field name="res_model">mrp.master.order</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="alterben_mrp_master_order.view_mrp_master_order_tree"/>
        <field name="domain">[('stage_type','=','curvado_pvb')]</field>
        <field name="context">{'default_stage_type':'curvado_pvb','form_view_ref':'alterben_mrp_master_order.view_mrp_master_order_form_curvado_split'}</field>
        <field name="views">[(ref('alterben_mrp_master_order.view_mrp_master_order_tree'),'tree'),(ref('alterben_mrp_master_order.view_mrp_master_order_form_curvado_split'),'form')]</field>
    </record>

    <!-- Acción OPT -->
    <record id="action_mrp_master_order_opt" model="ir.actions.act_window">
        <field name="name">Órdenes Producto Terminado (OPT)</field>
        <field name="res_model">mrp.master.order</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="alterben_mrp_master_order.view_mrp_master_order_tree"/>
        <field name="domain">[('stage_type','=','opt')]</field>
        <field name="context">{'default_stage_type':'opt','form_view_ref':'alterben_mrp_master_order.view_mrp_master_order_form_opt_split'}</field>
        <field name="views">[(ref('alterben_mrp_master_order.view_mrp_master_order_tree'),'tree'),(ref('alterben_mrp_master_order.view_mrp_master_order_form_opt_split'),'form')]</field>
    </record>
</odoo>
